<!DOCTYPE html>
<html lang="zh_CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  
  <meta name="keywords" content="网站关键字">
  <meta name="description" content="网站简介">
  
  <title>分享与进步</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="/css/materialize.min.css">
    
      <link rel="stylesheet" href="/css/main.min.css">
    
  
  <style type="text/css">
      html{
          font-family: sans-serif;
          font-weight: 300;
      }
      @font-face {
          font-family: 'Material Icons';
          font-style: normal;
          font-weight: 400;
          src: url(/fonts/MaterialIcons-Regular.eot);
          src: url(/fonts/MaterialIcons-Regular.woff2) format('woff2'),
          url(/fonts/MaterialIcons-Regular.woff) format('woff'),
          url(/fonts/MaterialIcons-Regular.ttf) format('truetype')
      }
  </style>
</head>
<body>
<div id="menu-box"><a href="javascript:void(0)" id="menu" data-activates="slide-out" class="button-collapse menu" ><span class="nav-btn"></span></a></div>
<div id="menu-outer">
  <div id="menu-inner">
      <ul id="slide-out" class="side-nav" >
    <div class="nav-header"  style="background-image: url(/images/header-bg.png);background-color:#26A69A">
    <div class="header-box"><img src="/images/header.png" ondragstart="return false;"></div>
    <p>David Chen</p>
    <div class="nav-link">
        
        <a href="https://twitter.com/DavidDivading" target="_blank"> <div class="link-box twitter"></div></a>
        
        
        <a  href="http://github.com/cbcing" target="_blank"><div class="link-box github"></div></a>
        
        
        <a href="mailto:davvvvvvidchen@gmail.com"><div class="link-box email"></div></a>
        
        
        <a href="https://weibo.com/3543577592/profile" target="_blank"><div class="link-box weibo"></div></a>
        
        
        <a href="http://example.com" target="_blank"> <div class="link-box zhihu"></div></a>
        
    </div>
    <div class="nav-search">
        <form id="search-form"> <!-- 搜索框相关 -->
            <input type="text" id="local-search-input" name="q" results="0" placeholder="搜索..." class="search form-control" autocomplete="off" autocorrect="off"/>
            <div class="nav-search-img"><i class="material-icons">search</i></div>
        </form>
        <div id="local-search-result"></div> <!-- 搜索结果区 -->
        <p class='no-result'>无搜索结果</p>
    </div>
</div>
    <!--Homepage-->

<li class="nav-list">
    <a href="/" target="_self">
        <div class="nav-ico"><i class="material-icons">home</i> </div><p>主页</p>
    </a>
</li>

<!--archives-->

<li class="nav-list dropdown-btn">
    <a  class=""  target="_self">
        <div class="nav-ico"><i class="material-icons">assignment</i></div><p>归档</p><div class="dropdown-ico"><i class="material-icons">arrow_drop_down</i></div>
    </a>
</li>

<ul class="dropdown-menu dropdown" >
    <li class="nav-dropdown-list">
        <a class="archive-link" href="/archives/2017/09/">九月 2017<span class="archive-count">3</span></a></li><li class="nav-dropdown-list"><a class="archive-link" href="/archives/2017/08/">八月 2017<span class="archive-count">1</span></a>
    </li>
</ul>
<!--categories-->

<li class="nav-list dropdown-btn">
    <a   class=""  target="_self">
        <div class="nav-ico"><i class="material-icons">dashboard</i></div><p>分类</p><div class="dropdown-ico"><i class="material-icons">arrow_drop_down</i></div>
    </a>
</li>

<ul class="dropdown-menu dropdown" >
    <li class="nav-dropdown-list">
        <a class="category-link" href="/categories/技术/">技术<span class="category-count">1</span></a></li><li class="nav-dropdown-list"><a class="category-link" href="/categories/比心/">比心<span class="category-count">1</span></a>
    </li>
</ul>
<!--tags-->

<li class="nav-list">
    <a href="/archives" target="_self">
        <div class="nav-ico"><i class="material-icons">bookmark</i> </div><p>标签</p>
    </a>
</li>

<!--photo-->

<li class="nav-list">
    <a href="/photo" class="nopjax" target="_self">
        <div class="nav-ico"><i class="material-icons">insert_photo</i> </div><p>影集</p>
    </a>
</li>

<!--friends-->

<li class="nav-list">
    <a href="/friends" target="_self">
        <div class="nav-ico"><i class="material-icons">face</i> </div><p>友链</p>
    </a>
</li>

<!--about-->

<li class="nav-list">
    <a href="/about" target="_self">
        <div class="nav-ico"><i class="material-icons">copyright</i> </div><p>关于</p>
    </a>
</li>


</ul>

  </div>
</div>

<div id="content-outer">
  <div id="content-inner">
    
<article id="post">
  <div class="post-page-title" style="background-color:#26A69A;background-image:url(/images/cbc/four.png)" >
  <h2>TCP协议的三次握手和四次分手过程</h2>
    
  <p>作者:David Chen &nbsp&nbsp 发布于:<time datetime="2017-09-18T07:08:21.000Z">
          2017-09-18
    </time>
  </p>
    
  </div>
  <div class="post-page-content">
  <p><strong>为以前贪玩买单系列。</strong></p>
<h3 id="情景"><a href="#情景" class="headerlink" title="情景"></a>情景</h3><p>在上海上大学的小明和他在成都上大学女票今天要进行视频聊天（四川话）：</p>
<p>小明：听得到不？听得到我说话不？乖乖</p>
<p>女票：听得到，听得到。你听得到我说话不？死鬼</p>
<p>小明：听得到。乖乖</p>
<p>之后，两人就进入各种问候，各种关心，各种思恋的对话。。。。。。</p>
<h3 id="TCP头部"><a href="#TCP头部" class="headerlink" title="TCP头部"></a>TCP头部</h3><p>来几张图片压压惊。</p>
<p><img src="/images/tcp_1.png" alt="tcp"></p>
<p><img src="/images/tcp_2.png" alt="tcp"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">0                   1                   2                   3   </div><div class="line">   0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 </div><div class="line">  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">  |          Source Port          |       Destination Port        |</div><div class="line">  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">  |                        Sequence Number                        |</div><div class="line">  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">  |                    Acknowledgment Number                      |</div><div class="line">  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">  |  Data |           |U|A|P|R|S|F|                               |</div><div class="line">  | Offset| Reserved  |R|C|S|S|Y|I|            Window             |</div><div class="line">  |       |           |G|K|H|T|N|N|                               |</div><div class="line">  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">  |           Checksum            |         Urgent Pointer        |</div><div class="line">  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">  |                    Options                    |    Padding    |</div><div class="line">  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">  |                             data                              |</div><div class="line">  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div></pre></td></tr></table></figure>
<p>解释：</p>
<table>
<thead>
<tr>
<th style="text-align:left">header 2</th>
<th style="text-align:center">大小(byte)</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Source Port</td>
<td style="text-align:center">2</td>
<td>source port number和destination port number：分别占用16位，表示源端口号和目的端口号；用于区别主机中的不同进程，而IP地址是用来区分不同的主机的，源端口号和目的端口号配合上IP首部中的源IP地址和目的IP地址就能唯一的确定一个TCP连接。</td>
</tr>
<tr>
<td style="text-align:left">Destination Port</td>
<td style="text-align:center">2</td>
<td>同上</td>
</tr>
<tr>
<td style="text-align:left">Sequence Number</td>
<td style="text-align:center">4</td>
<td>用来标识从TCP发端向TCP收端发送的数据字节流，它表示在这个报文段中的的第一个数据字节在数据流中的序号；主要用来解决网络报乱序的问题。</td>
</tr>
<tr>
<td style="text-align:left">Acknowledgment Number</td>
<td style="text-align:center">4</td>
<td>32位确认序列号包含发送确认的一端所期望收到的下一个序号，因此，确认序号应当是上次已成功收到数据字节序号加1。不过，只有当标志位中的ACK标志为1时该确认序列号的字段才有效。主要用来解决不丢包的问题。</td>
</tr>
<tr>
<td style="text-align:left">Data Offset</td>
<td style="text-align:center">1/2(4bit)</td>
<td>给出首部中32 bit字的数目，需要这个值是因为任选字段的长度是可变的。这个字段占4bit（最多能表示15个32bit的的字，即4*15=60个字节的首部长度），因此TCP最多有60字节的首部。然而，没有任选字段，正常的长度是20字节。</td>
</tr>
<tr>
<td style="text-align:left">Reserved</td>
<td style="text-align:center">3/4(6bit)</td>
<td>保留供将来使，发送为零。</td>
</tr>
<tr>
<td style="text-align:left">Control Flags</td>
<td style="text-align:center">3/4(6bit)</td>
<td>URG：此标志表示TCP包的紧急指针域有效，用来保证TCP连接不被中断，并且督促中间层设备要尽快处理这些数据。                                                                             ACK：此标志表示应答域有效，就是说前面所说的TCP应答号将会包含在TCP数据包中；有两个取值：0和1，为1的时候表示应答域有效，反之为0。                                                                                                                      PSH：这个标志位表示Push操作。所谓Push操作就是指在数据包到达接收端以后，立即传送给应用程序，而不是在缓冲区中排队。                                                          RST：这个标志表示连接复位请求。用来复位那些产生错误的连接，也被用来拒绝错误和非法的数据包。                                                                                                               SYN：表示同步序号，用来建立连接。SYN标志位和ACK标志位搭配使用，当连接请求的时候，SYN=1，ACK=0；连接被响应的时候，SYN=1，ACK=1；这个标志的数据包经常被用来进行端口扫描。扫描者发送一个只有SYN的数据包，如果对方主机响应了一个数据包回来 ，就表明这台主机存在这个端口；但是由于这种扫描方式只是进行TCP三次握手的第一次握手，因此这种扫描的成功表示被扫描的机器不很安全，一台安全的主机将会强制要求一个连接严格的进行TCP的三次握手。                                          FIN： 表示发送端已经达到数据末尾，也就是说双方的数据传送完成，没有数据可以传送了，发送FIN标志位的TCP数据包后，连接将被断开。这个标志的数据包也经常被用于进行端口扫描。</td>
</tr>
<tr>
<td style="text-align:left">Window</td>
<td style="text-align:center">2</td>
<td>窗口大小，也就是有名的滑动窗口，用来进行流量控制。</td>
</tr>
<tr>
<td style="text-align:left">Checksum</td>
<td style="text-align:center">2</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">Urgent Pointer</td>
<td style="text-align:center">2</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">Options</td>
<td style="text-align:center">可变</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">Padding</td>
<td style="text-align:center">可变</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">Data</td>
<td style="text-align:center">可变</td>
</tr>
</tbody>
</table>
<p>加餐：</p>
<p><img src="/images/tcp_3.png" alt="tcp 4"></p>
<h3 id="三次握手和四次分手"><a href="#三次握手和四次分手" class="headerlink" title="三次握手和四次分手"></a>三次握手和四次分手</h3><p>先上图</p>
<p><img src="/images/tcp_4.png" alt="tcp 3 handshark"></p>
<p><strong>三次握手：</strong></p>
<p>第一次握手：建立连接。客户端发送连接请求报文段，将SYN位置为1，Sequence Number为x；然后，客户端进入SYN_SEND状态，等待服务器的确认；</p>
<p>第二次握手：服务器收到SYN报文段。服务器收到客户端的SYN报文段，需要对这个SYN报文段进行确认，设置Acknowledgment Number为x+1(Sequence Number+1)；同时，自己还要发送SYN请求信息，将SYN位置为1，Sequence Number为y；服务器端将上述所有信息放到一个报文段（即SYN+ACK报文段）中，一并发送给客户端，此时服务器进入SYN_RECV状态；</p>
<p>第三次握手：客户端收到服务器的SYN+ACK报文段。然后将Acknowledgment Number设置为y+1，向服务器发送ACK报文段，这个报文段发送完毕以后，客户端和服务器端都进入ESTABLISHED状态，完成TCP三次握手。</p>
<p>之后，双方就可以进行传输数据。</p>
<p><strong>四次分手：</strong></p>
<p>第一次分手：主机1（可以使客户端，也可以是服务器端），设置Sequence Number和Acknowledgment Number，向主机2发送一个FIN报文段；此时，主机1进入FIN_WAIT_1状态；这表示主机1没有数据要发送给主机2了；</p>
<p>第二次分手：主机2收到了主机1发送的FIN报文段，向主机1回一个ACK报文段，Acknowledgment Number为Sequence Number加1；主机1进入FIN_WAIT_2状态；主机2告诉主机1，我“同意”你的关闭请求；</p>
<p>第三次分手：主机2向主机1发送FIN报文段，请求关闭连接，同时主机2进入LAST_ACK状态；</p>
<p>第四次分手：主机1收到主机2发送的FIN报文段，向主机2发送ACK报文段，然后主机1进入TIME_WAIT状态；主机2收到主机1的ACK报文段以后，就关闭连接；此时，主机1等待2MSL后依然没有收到回复，则证明Server端已正常关闭，那好，主机1也可以关闭连接了。</p>
<h3 id="为什么需要三次握手和四次分手"><a href="#为什么需要三次握手和四次分手" class="headerlink" title="为什么需要三次握手和四次分手"></a>为什么需要三次握手和四次分手</h3><p>未完待续</p>

  </div>
  <!--评论块-->
    

</article>
<nav class="post-nav">
  <!-- Prev Nav -->
    


  <!-- Next Nav -->
    
  <a href="/2017/09/09/分布式系统的追踪/" id="post_nav-older" class="post-nav-content next-content">
      旧篇
  </a>
    
</nav>
<div class="post-toc-btn"><i class="material-icons">format_list_numbered</i></div>
<div class="post-toc-none"><p>(无)</p></div>
<div class="post-toc-box">
    <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#情景"><span class="post-toc-number">1.</span> <span class="post-toc-text">情景</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#TCP头部"><span class="post-toc-number">2.</span> <span class="post-toc-text">TCP头部</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#三次握手和四次分手"><span class="post-toc-number">3.</span> <span class="post-toc-text">三次握手和四次分手</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#为什么需要三次握手和四次分手"><span class="post-toc-number">4.</span> <span class="post-toc-text">为什么需要三次握手和四次分手</span></a></li></ol>
</div>
<!--<div class="post-back"><i class="material-icons">arrow_back</i></div>-->
<script type="text/javascript">
    menu();
</script>
  </div>
</div>
<div id="bottom-outer">
  <div id="bottom-inner">
    <a  id="top-button" onfocus="this.blur();"><div class="up upinbody" style="background-color:#26A69A"><i class="material-icons material-up">vertical_align_top</i></div></a>


<p style="line-height: 45px">Copyright ©  2017  分享与进步</p>
<p style="line-height: 45px">Powered by <a href="https://hexo.io/" target="_blank"> Hexo </a> && Theme - <a href="https://github.com/moumao/hexo-theme-Vateral" target="_blank">Vateral</a></p>

  </div>
</div>

<!--影集界面需要的资源-->



<!-- scripts list from theme config.yml -->

<script src="/js/jquery-3.1.1.min.js"></script>

<script src="/js/materialize.min.js"></script>

<script src="/js/main.min.js"></script>


<script>
    NProgress.start();
    NProgress.done();
    lazy();
    links();
    window.onpopstate = menu();
    //pjax操作
    $(document).pjax('a:not(.nopjax)', '#content-inner', {fragment:'#content-inner', timeout:8000});
    $(document).on('pjax:start', NProgress.start).on('pjax:end', NProgress.done)
        .on('pjax:end', () => {
            dowmdiv();
            lazy();
            toc();
            links();
            menu();
        });
</script>

</body>
</html>
